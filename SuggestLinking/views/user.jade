extends user-layout

mixin suggestedUserMixin(identity)
  tr(data-id='#{identity.user_id}')
    td #{identity.user_id}
    td #{identity.provider || identity.user_id.split('|')[0]}
    td 
      if (identity.picture)
        img.profile-image(src='#{identity.picture}')
    td #{identity.name}
    td #{identity.nickname}
    td #{identity.user_metadata}
    td #{identity.app_metadata}  
    td
      button.btn.btn-success.btn-xs.unlink(onclick='linkAccount("#{identity.user_id}")') link 

mixin identityMixin(identity)
  tr(data-id='#{identity.user_id}')
    td #{identity.provider}
    td #{identity.connection}
    td 
      if (identity.profileData && identity.profileData.picture)
        img.profile-image(src='#{identity.profileData && identity.profileData.picture}')
    td #{identity.profileData && identity.profileData.name}
    td #{identity.profileData && identity.profileData.email}&nbsp;
      if (identity.profileData && identity.profileData.email && identity.profileData.email_verified)
        span.label.label-success verified
      else if (identity.profileData && identity.profileData.email)
        span.label.label-danger not verified
    td
      button.btn.btn-danger.btn-xs.unlink(onclick='unlinkAccount("#{identity.provider}","#{identity.user_id}")') unlink 

mixin description(label,val)
  dt #{label}
  dd #{val}

block content
  
  .panel.panel-default
    .panel-heading 
      img.img-circle.profile-image(src='#{user.picture}') 
      |Root Profile 
    .panel-body
      dl.dl-horizontal
        dt email
        dd #{user.email} &nbsp;
          if (user.email_verified)
            span.label.label-success verified
          else
            span.label.label-danger not verified
        +description('name',user.name)
        +description('provider',provider)
        +description('given_name',user.given_name)
        +description('family_name',user.family_name)
        +description('locale',user.locale)
        +description('user_id',user.user_id)
        +description('nickname',user.nickname)
        +description('user_metadata',JSON.stringify(user.user_metadata,null,4))
        +description('app_metadata',JSON.stringify(user.app_metadata,null,4))

  .panel.panel-default
      .panel-heading Linked Accounts
      if (user.identities.length > 1)
        table.table.identities
          thead
            tr
              th provider
              th connection
              th(style='width:5%')
              th name
              th email
              th actions
          tbody
          each identity in user.identities
            +identityMixin(identity)
      else
        .panel-body
          p You don't have any accounts linked.
        .panel-footer
          button.btn.btn-primary(onclick='linkAccount()') Link another account

  .modal.modal-lg#suggest-modal
    .modal-dialog
      .modal-content
        .modal-header
          button(type="button" class="close" data-dismiss="modal" aria-hidden="true") Ã—
          h4 Link Accounts
        .modal-body
          p We noticed there are other registered users with same and verified e-mail address: <strong>#{user.email}</strong>. Do you want to link the accounts?
          table.table.table-condensed
            thead
              tr
                th user_id
                th name
                th user_metadata
                th app_metadata
                th actions
            tbody#suggested-users
        .modal-footer
          button.btn.btn-default(type="button" data-dismiss="modal") No, thanks.

  script.
    var auth0Domain = '#{env.AUTH0_DOMAIN}';
    var rootUserId = '#{user.user_id}';
    var accessToken = '#{access_token}';
    var user = !{JSON.stringify(user)};
    console.log('user',user);
    
    function linkAccount(userId) {
      $.ajax({
        type: 'POST',
        url: `/user/link-accounts/${userId}`,
      }).then(function(){
        alert('linked!!');
        location.reload();
      }).fail(function(err){
        alert('error ' + err);
      });
    }

    function unlinkAccount(provider,userId){
      $.ajax({
        type: 'POST',
        url: `/user/unlink-accounts/${provider}|${userId}`,
      }).then(function(){
        alert('unlinked!!');
        location.reload();
      }).fail(function(err){
        alert('error ' + err);
      });
    }

    function getSuggestedUsers(){
      $.ajax({
        url: '/user/suggested-users'
      }).then(function(identities){
        if (identities.length > 0){

          $('#suggested-users tr').remove();

          $.each(identities,function(index,identity){
            $('#suggested-users').append(
              `<tr>
                <td>${identity.user_id}</td>
                <td>${identity.name}</td>
                <td>${identity.user_metadata}</td>
                <td>${identity.app_metadata}</td>
                <td><button onclick="linkAccount('${identity.user_id}')" class="btn btn-success">Link</button></td>
              </tr>`);
          });

          $('#suggest-modal').modal();
        }
      }).fail(function(err){
        console.log('error getting suggested users', err);
      });
    }

    function isRootIdentity(identity){
      return identity.provider === rootUserId.split('|')[0] && identity.user_id === rootUserId.split('|')[1];
    }

    $(document).ready(function() {
      //exclude root identity from the table of Linked Accounts
      $.each(user.identities,function(index,identity){
        if (isRootIdentity(identity)){
          $(`table.identities tr[data-id='${identity.user_id}']`).hide();
        }
      });

      //request suggested accounts to link to
      if (user.email_verified){
        getSuggestedUsers();
      }

    });
